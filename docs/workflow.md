# 재입고 알림 시스템 workflow

- 시퀀스 다이어그램 같은 도구를 활용하면 좋겠지만, 시간 관계상 생략
- 대신, 구현하고자 하는 동작의 플로우를 문서로 기술

<br>

## 1. 전송 상태 4가지 단계

1. `전송 전` : DB에서 필요한 정보들을 메모리로 로드하는 과정


2. `전송 중` : 메모리에 로드된 정보로 알림을 전달

   &rarr; 이번 시스템에선 알림을 보내는 동작은 생략, history에 저장하는 동작을 수행해야 함.


3. `전송 완료` : 알림이 성공적으로 전달됐다면, history에 기록

   &rarr; 이곳에서 말하는 history란, 사용자에게 이 알림을 전달했다는 것을 저장하는 history가 될 것이다.


4. `재전송` : 모종의 이유로 알림이 전달되지 않았다가, 별도의 api 요청을 받고 다시 전송되는 상태

<br>

## 2. 기본 설계

### 선행조건

1. 클라이언트에서 서버로 "재입고 알림 전송 API" 요청
2. `product`의 수량이 1 이상인지 확인

   2-1. 만약 수량이 1 이상이면 `product`의 `restock_count`를 1증가

   2-2. 만약 수량이 1 미만이면 예외

### 전송 전

3. `product_user_notification`에서 해당 `product`에 재입고 알림 신청을 한 `user_id`를 `오래된 순`으로 조회

### 전송 중

4. `product_notification_history`에 위 `user_id`와 `status`를 저장

   4-1. `product`의 `quantity`가 1미만이면, `CANCELED_BY_SOLD_OUT`로 저장

   4-2. 예외가 발생했다면 `CANCELED_BY_ERROR`로 저장

   4-3. 아무 문제가 없다면, `COMPLETED`로 저장

### 전송 완료

5. `product_user_notification_history`에 4번 동작을 통해 `COMPLETED`된 알림을 저장

### 재전송

6. 만약 admin의 "재입고 알림 전송 API"가 온다면, 해당 `product_notification_history`의 `status`가 `CANCELED_BY_ERROR `인 알림을 다시 전송 시도

<br>

## 3. 추가 설계

1. "마지막으로 전송 성공한 이후 유저부터 다시 알림메시지를 보낼 수 있어야 한다"는 어떻게 구현?

    1. 현재 상품의 재입고 회차에 맞는 `product_notification_history`의 히스토리 중 `CANCELED_BY_ERROR`인 알림 목록을 조회
    2. 다시 순차 전송


2. 알림 메시지는 1초에 최대 500개의 요청을 처리할 수 있어야 된다는 것은 어떻게 구현해야 될까?

    1. bucket4j라는 라이브러리를 도입해보자. 직접 구현하기엔 시간이 없다.


3. 재고 상태 관리

    1. 알림이 전송되는 과정에서, 실시간으로 구매로 인한 재고 감소 상황도 고려해야 한다.
    2. 때문에, 해당 재고를 알림 시스템에서 매번 모니터링하는 동작이 필요하다.
    3. 알림 전송 시점에, DB에서 재고를 주기적으로 조회해서 캐싱하는 과정을 도입하자. DB부하를 피할 수 있을 것 같다.